<script type="text/html" data-template-name="jack-value">
    <div class="form-row">
        <label for="node-input-name">
            <i class="fa fa-tag"></i> <span data-i18n="@ptweety/node-red-contrib-ccu-jack/messages:common.label.name"></span>
        </label>
        <input type="text" id="node-input-name" data-i18n="[placeholder]@ptweety/node-red-contrib-ccu-jack/messages:value.input.name" style="width: calc(100% - 105px)">
    </div>

    <div class="form-row">
        <label for="node-input-jack">
            <i class="fa fa-globe"></i> <span data-i18n="@ptweety/node-red-contrib-ccu-jack/messages:config.label.name"></span>
        </label>
        <input type="text" id="node-input-jack" style="width: calc(100% - 105px)">
    </div>

    <div class="form-row">
        <label for="node-input-topic">
            <i class="fa fa-tasks"></i> <span data-i18n="@ptweety/node-red-contrib-ccu-jack/messages:common.label.topic"></span>
        </label>
        <input type="text" id="node-input-topic" data-i18n="[placeholder]@ptweety/node-red-contrib-ccu-jack/messages:value.input.topic" style="width: calc(100% - 105px)">
    </div>

    <div class="form-row">
        <label for="node-input-domain"><i class="fa fa-empire"></i> domain</label>
        <select id="node-input-domain"></select>
    </div>

    <div class="form-row">
        <label for="node-input-device">device</label>
        <input type="text" id="node-input-device" class="node-typed-input-property-value" style="width: calc(100% - 105px)">
        <input type="hidden" id="node-input-deviceT" class="node-typed-input-property-type">
    </div>

    <div class="form-row">
        <label for="node-input-channelIndex">channelIndex</label>
        <input type="text" id="node-input-channelIndex" class="node-typed-input-property-value" style="width: calc(100% - 105px)">
        <input type="hidden" id="node-input-channelIndexT" class="node-typed-input-property-type">
    </div>

    <div class="form-row">
        <label for="node-input-datapoint">datapoint</label>
        <input type="text" id="node-input-datapoint" class="node-typed-input-property-value" style="width: calc(100% - 105px)">
        <input type="hidden" id="node-input-datapointT" class="node-typed-input-property-type">
    </div>

    <div class="form-row">
        <label for="node-input-change"> </label>
        <input type="checkbox" id="node-input-change" style="width: 22px; vertical-align: top;">
        <span data-i18n="@ptweety/node-red-contrib-ccu-jack/messages:value.label.change"></span>
    </div>

    <div class="form-row">
        <label for="node-input-cache"> </label>
        <input type="checkbox" id="node-input-cache" style="width: 22px; vertical-align: top;">
        <span data-i18n="@ptweety/node-red-contrib-ccu-jack/messages:value.label.cache"></span>
    </div>

    <div class="form-tips" style="max-width: unset; width: calc(100% - 18px)">
        <b>Important:</b> deploy server node to get devices list
    </div>
</script>

<script type="text/javascript">
(function () {
    'use strict';

    /** Module name must match this nodes html file @constant {string} moduleName */
    const moduleName = 'jack-value';
    /** Node's palette category @constant {string} paletteCategory */
    const paletteCategory = 'Jack';
    /** Node's background color @constant {string} paletteColor */
    const paletteColor = '#c2abc2';

    /** Dummy logging
     * @type {Object<string, Function>} */
    const dummyLog = {
        fatal: function () {}, // fatal - only those errors which make the application unusable should be recorded
        error: function () {}, // error - record errors which are deemed fatal for a particular request + fatal errors
        warn: function () {}, // warn - record problems which are non fatal + errors + fatal errors
        info: function () {}, // info - record information about the general running of the application + warn + error + fatal errors
        debug: function () {}, // debug - record information which is more verbose than info + info + warn + error + fatal errors
        trace: function () {}, // trace - record very detailed logging + debug + info + warn + error + fatal errors
    };
    let log = dummyLog;

    //#region ---- Communication with runtime ----

    function getDataFromRuntime(domain) {
        const $nodeInputDomain = $('#node-input-domain');
        const nodeId = $('#node-input-jack').val();
        const result = {};

        log.debug(`getDataFromRuntime(${domain})`);

        $.ajax({ url: `jack/${nodeId}/all`, dataType: 'json', async: false, cache: false })
            .done((responseJSON) => {
                const debug = responseJSON?.debug || false;
                log.debug = debug ? console.debug : function () {};

                result.domains = responseJSON?.domains || {};
                // result.program = responseJSON?.program || {};
                // result.sysvar = responseJSON?.sysvar || {};
                result.device = responseJSON?.device || {};
                result.virtdev = responseJSON?.virtdev || {};

                log.debug('data', result);

                $nodeInputDomain.empty().append('<option value="">*</option>');
                for (const index of Object.keys(result.domains)) {
                    if (['device', 'virtdev'].includes(index))
                        $nodeInputDomain.append(
                            '<option value="' +
                                index +
                                (index === domain ? '" selected>' : '">') +
                                result.domains[index].title +
                                '</option>'
                        );
                }
                log.debug(`selected domain: ${$nodeInputDomain.val()}`);
            })
            .fail((jqXHR, textStatus, error) => {
                log.debug({ jqXHR, textStatus, error });
                RED.notify(`Request failed with: ${jqXHR.status} (${error})`, 'error');
            });

        return result;
    }

    function getDeviceTreeFromRuntime(domain) {
        const nodeId = $('#node-input-jack').val();

        let result = {};
        if (nodeId === '_ADD_') return result;
        if (!['device', 'virtdev'].includes(domain)) return result;

        log.debug(`getDeviceTreeFromRuntime(${domain})`);
        const queryItems = { domain };
        for (const item of ['device', 'channelIndex', 'datapoint']) {
            queryItems[item] = $(`#node-input-${item}`).val();
            queryItems[item + 'T'] = $(`#node-input-${item}T`).val();
        }

        $.ajax({ url: `jack/${nodeId}/tree`, data: queryItems, dataType: 'json', async: false, cache: false })
            .done((responseJSON) => {
                log.debug(`${domain} data`, responseJSON);
                result = responseJSON;
            })
            .fail((jqXHR, textStatus, error) => {
                log.debug({ jqXHR, textStatus, error });
                RED.notify(`Request failed with: ${jqXHR.status} (${error})`, 'error');
            });

        return result;
    }

    //#endregion ---- Communication with runtime ----

    //#region ---- Search ----

    function getMatch(value, searchValue) {
        const index = value.toLowerCase().indexOf(searchValue.toLowerCase());
        const length = index > -1 ? searchValue.length : 0;
        return {
            index: index,
            found: index > -1,
            pre: value.slice(0, Math.max(0, index)),
            match: value.slice(index, index + length),
            post: value.slice(Math.max(0, index + length)),
        };
    }

    function generateSpans(match) {
        const elements = [];
        if (match.pre) {
            elements.push($('<span/>').text(match.pre));
        }
        if (match.match) {
            elements.push(
                $('<span/>', {
                    style: 'font-weight: bold; color: var(--red-ui-text-color-link);',
                }).text(match.match)
            );
        }
        if (match.post) {
            elements.push($('<span/>').text(match.post));
        }
        return elements;
    }

    function autoCompleteSearch(node, data, input, value) {
        log.debug(`autoCompleteSearch(${value})`);
        try {
            const $nodeInputDomain = $('#node-input-domain');
            const domain = $nodeInputDomain.val() === null ? node.domain : $nodeInputDomain.val();
            const options = ['program', 'sysvar'].includes(domain)
                ? data[domain][input]
                : getDeviceTreeFromRuntime(domain)[input];

            let matches = [];
            for (const opt of options) {
                const optValue = opt.value;
                const optSource = (opt.source || []).join(',');
                const valueMatch = getMatch(optValue, value);
                const sourceMatch = getMatch(optSource, value);
                if (valueMatch.found || sourceMatch.found) {
                    const element = $('<div>', { style: 'display: flex' });
                    const valueElement = $('<div/>', {
                        style: 'font-family: var(--red-ui-monospace-font); white-space:nowrap; overflow: hidden; flex-grow:1',
                    });
                    valueElement.append(generateSpans(valueMatch));
                    valueElement.appendTo(element);
                    if (optSource) {
                        const optElement = $('<div>').css({ 'font-size': '0.8em' });
                        optElement.append(generateSpans(sourceMatch));
                        optElement.appendTo(element);
                    }
                    matches.push({
                        value: optValue,
                        label: element,
                        i: valueMatch.found ? valueMatch.index : sourceMatch.index,
                    });
                }
            }

            matches.sort(function (A, B) {
                return A.i - B.i;
            });
            matches.unshift({ value: '', label: '*' });

            log.debug('matches', matches);
            return matches;
        } catch (error) {
            log.debug(error);
        }
    }

    //#endregion ---- Search ----

    // function refreshFormRows(domain) {
    //     $('.form-row').each(function () {
    //         for (const item of ['device', 'program', 'sysvar', 'virtdev']) {
    //             if ($(this).hasClass(`for-${item}`)) {
    //                 $(this).hide();
    //             }
    //         }
    //         if ($(this).hasClass(`for-${domain}`)) $(this).show();
    //     });
    // }

    function onEditPrepare(node) {
        const $nodeInputJack = $('#node-input-jack');
        const $nodeInputDomain = $('#node-input-domain');
        const $nodeInputTopic = $('#node-input-topic');

        let domain;
        const refreshDomain = () => {
            domain = $nodeInputDomain.val() === null ? node.domain : $nodeInputDomain.val();
        };
        refreshDomain();

        let data = getDataFromRuntime(domain);
        // refreshFormRows(domain);

        $nodeInputJack.on('change', (event, type, value) => {
            log.debug(`${$(this).attr('id')}.on('change', ${event.target.id}, ${type}, ${value})`);
            refreshDomain();
            data = getDataFromRuntime(domain);
            // refreshFormRows(domain);
        });

        $nodeInputDomain.on('change', (event, type, value) => {
            log.debug(`${$(this).attr('id')}.on('change', ${event.target.id}, ${type}, ${value})`);
            refreshDomain();
            // refreshFormRows(domain);
            $nodeInputTopic.trigger('focus');
        });

        $nodeInputTopic.autoComplete({
            delay: 0,
            minLength: 0,
            search: function () {
                return ['*', '${domain}/status/${device}/${channelIndex}/${datapoint}'].map((value) => {
                    return { value, label: value };
                });
            },
        });

        $('.node-typed-input-property-value').each(function () {
            $(this).typedInput({
                types: [
                    {
                        value: 'str',
                        label: 'string',
                        icon: 'red/images/typedInput/az.svg',
                        autoComplete: (value) => autoCompleteSearch(node, data, $(this).attr('id').slice(11), value),
                    },
                    { value: 're', label: 'regular expression', icon: 'red/images/typedInput/re.svg' },
                ],
                typeField: '#' + $(this).attr('id') + 'T',
            });
        });
    }

    RED.nodes.registerType(moduleName, {
        category: paletteCategory,
        color: paletteColor,
        defaults: {
            name: { value: '' },
            jack: { value: 'localhost', type: 'jack-config', required: true },
            domain: { value: '*' },
            topic: { value: '*' },
            device: { value: '' },
            deviceT: { value: 'str' },
            channelIndex: { value: '' },
            channelIndexT: { value: 'str' },
            datapoint: { value: '' },
            datapointT: { value: 'str' },
            change: { value: false },
            cache: { value: false },
        },
        align: 'right',
        icon: 'bridge.svg',
        inputs: 1,
        outputs: 1,
        label: function () {
            return this.name || this._('@ptweety/node-red-contrib-ccu-jack/messages:value.label.name');
        },
        paletteLabel: function () {
            return this._('@ptweety/node-red-contrib-ccu-jack/messages:value.label.name');
        },
        outputLabels: function (_) {
            return this._('@ptweety/node-red-contrib-ccu-jack/messages:value.node.output');
        },
        oneditprepare: function () {
            onEditPrepare(this);
        },
        oneditsave: function () {
            // const $nodeInputDomain = $('#node-input-domain');
            // const domain = $nodeInputDomain.val() || '';
            //
            // $('.node-typed-input-property-value').each(function () {
            //     if (!$(this).parent().hasClass(`for-${domain}`)) {
            //         $(this).typedInput('type', 'str');
            //         $(this).typedInput('value', '');
            //     }
            // });
        },
    });
})();
</script>