<script type="text/html" data-template-name="jack-event">
    <div class="form-row">
        <label for="node-input-name">
            <i class="fa fa-tag"></i> <span data-i18n="@ptweety/node-red-contrib-ccu-jack/messages:common.label.name"></span>
        </label>
        <input type="text" id="node-input-name" data-i18n="[placeholder]@ptweety/node-red-contrib-ccu-jack/messages:event.input.name" style="width: calc(100% - 105px)">
    </div>

    <div class="form-row">
        <label for="node-input-jack">
            <i class="fa fa-globe"></i> <span data-i18n="@ptweety/node-red-contrib-ccu-jack/messages:config.label.name"></span>
        </label>
        <input type="text" id="node-input-jack" style="width: calc(100% - 105px)">
    </div>

    <div class="form-row">
        <label for="node-input-topic">
            <i class="fa fa-tasks"></i> <span data-i18n="@ptweety/node-red-contrib-ccu-jack/messages:common.label.topic"></span>
        </label>
        <input type="text" id="node-input-topic" data-i18n="[placeholder]@ptweety/node-red-contrib-ccu-jack/messages:event.input.topic" style="width: calc(100% - 105px)">
    </div>

    <div class="form-row">
        <label for="node-input-domain"><i class="fa fa-empire"></i> domain</label>
        <select id="node-input-domain"></select>
    </div>

    <div class="form-row for-device for-virtdev">
        <label for="node-input-interfaceType">interfaceType</label>
        <input type="text" id="node-input-interfaceType" class="node-typed-input-property-value" style="width: calc(100% - 105px)">
        <input type="hidden" id="node-input-interfaceTypeT" class="node-typed-input-property-type">
    </div>

    <div class="form-row for-device for-virtdev">
        <label for="node-input-room">room</label>
        <input type="text" id="node-input-room" class="node-typed-input-property-value" style="width: calc(100% - 105px)">
        <input type="hidden" id="node-input-roomT" class="node-typed-input-property-type">
    </div>

    <div class="form-row for-device for-virtdev">
        <label for="node-input-function">function</label>
        <input type="text" id="node-input-function" class="node-typed-input-property-value" style="width: calc(100% - 105px)">
        <input type="hidden" id="node-input-functionT" class="node-typed-input-property-type">
    </div>

    <div class="form-row for-device for-virtdev">
        <label for="node-input-device">device</label>
        <input type="text" id="node-input-device" class="node-typed-input-property-value" style="width: calc(100% - 105px)">
        <input type="hidden" id="node-input-deviceT" class="node-typed-input-property-type">
    </div>

    <div class="form-row for-device for-virtdev">
        <label for="node-input-deviceType">deviceType</label>
        <input type="text" id="node-input-deviceType" class="node-typed-input-property-value" style="width: calc(100% - 105px)">
        <input type="hidden" id="node-input-deviceTypeT" class="node-typed-input-property-type">
    </div>

    <div class="form-row for-device for-virtdev">
        <label for="node-input-channel">channel</label>
        <input type="text" id="node-input-channel" class="node-typed-input-property-value" style="width: calc(100% - 105px)">
        <input type="hidden" id="node-input-channelT" class="node-typed-input-property-type">
    </div>

    <div class="form-row for-device for-virtdev">
        <label for="node-input-channelType">channelType</label>
        <input type="text" id="node-input-channelType" class="node-typed-input-property-value" style="width: calc(100% - 105px)">
        <input type="hidden" id="node-input-channelTypeT" class="node-typed-input-property-type">
    </div>

    <div class="form-row for-device for-virtdev">
        <label for="node-input-channelType">channelIndex</label>
        <input type="text" id="node-input-channelIndex" class="node-typed-input-property-value" style="width: calc(100% - 105px)">
        <input type="hidden" id="node-input-channelIndexT" class="node-typed-input-property-type">
    </div>

    <div class="form-row for-device for-virtdev">
        <label for="node-input-datapoint">datapoint</label>
        <input type="text" id="node-input-datapoint" class="node-typed-input-property-value" style="width: calc(100% - 105px)">
        <input type="hidden" id="node-input-datapointT" class="node-typed-input-property-type">
    </div>

    <div class="form-row for-program">
        <label for="node-input-program">program</label>
        <input type="text" id="node-input-program" class="node-typed-input-property-value" style="width: calc(100% - 105px)">
        <input type="hidden" id="node-input-programT" class="node-typed-input-property-type">
    </div>

    <div class="form-row for-sysvar">
        <label for="node-input-sysvar">sysvar</label>
        <input type="text" id="node-input-sysvar" class="node-typed-input-property-value" style="width: calc(100% - 105px)">
        <input type="hidden" id="node-input-sysvarT" class="node-typed-input-property-type">
    </div>

    <div class="form-row">
        <label for="node-input-change"> </label>
        <input type="checkbox" id="node-input-change" style="width: 22px; vertical-align: top;">
        <span data-i18n="@ptweety/node-red-contrib-ccu-jack/messages:event.label.change"></span>
    </div>

    <div class="form-row">
        <label for="node-input-cache"> </label>
        <input type="checkbox" id="node-input-cache" style="width: 22px; vertical-align: top;">
        <span data-i18n="@ptweety/node-red-contrib-ccu-jack/messages:event.label.cache"></span>
    </div>

    <div class="form-tips" style="max-width: unset; width: calc(100% - 18px)">
        <b>Important:</b> deploy server node to get devices list
    </div>
</script>

<script type="text/javascript">
(function () {
    'use strict';

    /** Module name must match this nodes html file @constant {string} moduleName */
    const moduleName = 'jack-event';
    /** Node's palette category @constant {string} paletteCategory */
    const paletteCategory = 'Jack';
    /** Node's background color @constant {string} paletteColor */
    const paletteColor = '#c2abc2';

    /** Dummy logging
     * @type {Object<string, Function>} */
    const dummyLog = {
        fatal: function () {}, // fatal - only those errors which make the application unusable should be recorded
        error: function () {}, // error - record errors which are deemed fatal for a particular request + fatal errors
        warn: function () {}, // warn - record problems which are non fatal + errors + fatal errors
        info: function () {}, // info - record information about the general running of the application + warn + error + fatal errors
        debug: function () {}, // debug - record information which is more verbose than info + info + warn + error + fatal errors
        trace: function () {}, // trace - record very detailed logging + debug + info + warn + error + fatal errors
    };
    let log = dummyLog;

    //#region ---- Communication with runtime ----

    function getDataFromRuntime(domain) {
        const $nodeInputDomain = $('#node-input-domain');
        const nodeId = $('#node-input-jack').val();
        const result = {};

        log.debug(`getDataFromRuntime(${domain})`);

        $.ajax({ url: `jack/${nodeId}/all`, dataType: 'json', async: false, cache: false })
            .done((responseJSON) => {
                const debug = responseJSON?.debug || false;
                log.debug = debug ? console.debug : function () {};

                result.domains = responseJSON?.domains || [];
                result.rooms = responseJSON?.rooms || [];
                result.functions = responseJSON?.functions || [];
                result.program = responseJSON?.program || [];
                result.sysvar = responseJSON?.sysvar || [];
                result.device = responseJSON?.device || [];
                result.virtdev = responseJSON?.virtdev || [];

                log.debug('data', result);

                $nodeInputDomain.empty().append('<option value="">*</option>');
                for (const index of result.domains) {
                    $nodeInputDomain.append(
                        '<option value="' +
                            index.identifier +
                            (index.identifier === domain ? '" selected>' : '">') +
                            index.title +
                            '</option>'
                    );
                }
                log.debug(`selected domain: ${$nodeInputDomain.val()}`);
            })
            .fail((jqXHR, textStatus, error) => {
                log.debug({ jqXHR, textStatus, error });
                RED.notify(`Request failed with: ${jqXHR.status} (${error})`, 'error');
            });

        return result;
    }

    //#endregion ---- Communication with runtime ----

    //#region ---- Search ----

    function getMatch(value, searchValue) {
        const index = value.toLowerCase().indexOf(searchValue.toLowerCase());
        const length = index > -1 ? searchValue.length : 0;
        return {
            index: index,
            found: index > -1,
            pre: value.slice(0, Math.max(0, index)),
            match: value.slice(index, index + length),
            post: value.slice(Math.max(0, index + length)),
        };
    }

    function generateSpans(match) {
        const elements = [];
        if (match.pre) {
            elements.push($('<span/>').text(match.pre));
        }
        if (match.match) {
            elements.push(
                $('<span/>', {
                    style: 'font-weight: bold; color: var(--red-ui-text-color-link);',
                }).text(match.match)
            );
        }
        if (match.post) {
            elements.push($('<span/>').text(match.post));
        }
        return elements;
    }

    function filterDataByInput(domain, data, input) {
        const $interfaceType = input === 'interfaceType' ? '' : $('#node-input-interfaceType').val();
        const $room = input === 'room' ? '' : $('#node-input-room').val();
        const $function = input === 'function' ? '' : $('#node-input-function').val();
        const $device = input === 'device' ? '' : $('#node-input-device').val();
        const $deviceType = input === 'deviceType' ? '' : $('#node-input-deviceType').val();
        const $channel = input === 'channel' ? '' : $('#node-input-channel').val();
        const $channelType = input === 'channelType' ? '' : $('#node-input-channelType').val();
        const $channelIndex = input === 'channelIndex' ? '' : $('#node-input-channelIndex').val();
        const $datapoint = input === 'datapoint' ? '' : $('#node-input-datapoint').val();

        const lists = {
            interfaceType: new Set(),
            room: new Set(),
            function: new Set(),
            device: [],
            deviceType: new Set(),
            channel: [],
            channelType: new Set(),
            channelIndex: new Set(),
            datapoint: new Set(),
        };

        for (const device of data[domain]) {
            if ($interfaceType.length > 0 && $interfaceType !== device.interfaceType) continue;
            if ($device.length > 0 && $device !== device.value) continue;
            if ($deviceType.length > 0 && $deviceType !== device.deviceType) continue;

            let matchChannel = false;
            for (const channel of device.channels) {
                if ($channel.length > 0 && $channel !== channel.value) continue;
                if ($channelType.length > 0 && $channelType !== channel.channelType) continue;
                if ($channelIndex.length > 0 && $channelIndex !== channel.channelIndex) continue;

                if ($room.length > 0 && channel.rooms.includes($room)) continue;
                if ($function.lenght > 0 && channel.functions.includes($function)) continue;

                let matchDatapoint = false;
                for (const datapoint of channel.datapoints) {
                    if ($datapoint.length > 0 && $datapoint !== datapoint.value) continue;

                    matchDatapoint = true;
                    const { value } = datapoint;

                    lists.datapoint.add(value);
                }

                if (matchDatapoint) {
                    matchChannel = true;
                    const { value, source, channelType, channelIndex, rooms, functions } = channel;

                    lists.channel.push({ value, source });
                    lists.channelType.add(channelType);
                    lists.channelIndex.add(channelIndex);

                    for (const item of rooms) lists.room.add(item);
                    for (const item of functions) lists.function.add(item);
                }
            }

            if (matchChannel) {
                const { value, source, deviceType, interfaceType } = device;

                lists.device.push({ value, source });
                lists.deviceType.add(deviceType);
                lists.interfaceType.add(interfaceType);
            }
        }

        let options = [];
        if (lists[input] instanceof Set && ['room', 'function'].includes(input)) {
            options = [...lists[input]].map((value) => {
                const item = data[`${input}s`].find((element) => element.value === value);
                return item || { value };
            });
        } else if (lists[input] instanceof Set) {
            options = [...lists[input]].map((value) => ({ value }));
        } else options = lists[input];

        return options;
    }

    function autoCompleteSearch(node, data, input, value) {
        log.debug(`autoCompleteSearch(${input}, ${value})`);
        try {
            const $Domain = $('#node-input-domain');
            const domain = $Domain.val() === null ? node.domain : $Domain.val();

            let options = ['program', 'sysvar'].includes(input) ? data[input] : filterDataByInput(domain, data, input);

            let matches = [];
            for (const opt of options) {
                const optValue = opt.value;
                const optSource = (opt.source || []).join(',');
                const valueMatch = getMatch(optValue, value);
                const sourceMatch = getMatch(optSource, value);
                if (valueMatch.found || sourceMatch.found) {
                    const element = $('<div>', { style: 'display: flex' });
                    const valueElement = $('<div/>', {
                        style: 'font-family: var(--red-ui-monospace-font); white-space:nowrap; overflow: hidden; flex-grow:1',
                    });
                    valueElement.append(generateSpans(valueMatch));
                    valueElement.appendTo(element);
                    if (optSource) {
                        const optElement = $('<div>').css({ 'font-size': '0.8em' });
                        optElement.append(generateSpans(sourceMatch));
                        optElement.appendTo(element);
                    }
                    matches.push({
                        value: optValue,
                        label: element,
                        i: valueMatch.found ? valueMatch.index : sourceMatch.index,
                    });
                }
            }

            matches.sort(function (A, B) {
                return A.i - B.i;
            });
            matches.unshift({ value: '', label: '*' });

            // log.debug('matches', matches);
            return matches;
        } catch (error) {
            log.debug(`autoCompleteSearch: ${error}`);
        }
    }

    //#endregion ---- Search ----

    function refreshFormRows(domain) {
        $('.form-row').each(function () {
            for (const item of ['device', 'program', 'sysvar', 'virtdev']) {
                if ($(this).hasClass(`for-${item}`)) {
                    $(this).hide();
                }
            }
            if ($(this).hasClass(`for-${domain}`)) $(this).show();
        });
    }

    function onEditPrepare(node) {
        const $nodeInputJack = $('#node-input-jack');
        const $nodeInputDomain = $('#node-input-domain');
        const $nodeInputTopic = $('#node-input-topic');

        let domain;
        const refreshDomain = () => {
            domain = $nodeInputDomain.val() === null ? node.domain : $nodeInputDomain.val();
        };
        refreshDomain();

        let data; // = getDataFromRuntime(domain);
        refreshFormRows(domain);

        $nodeInputJack.on('change', (event, type, value) => {
            log.debug(`${$(this).attr('id')}.on('change', ${event.target.id}, ${type}, ${value})`);
            refreshDomain();
            data = getDataFromRuntime(domain);
            refreshFormRows(domain);
        });

        $nodeInputDomain.on('change', (event, type, value) => {
            log.debug(`${$(this).attr('id')}.on('change', ${event.target.id}, ${type}, ${value})`);
            refreshDomain();
            refreshFormRows(domain);
            $nodeInputTopic.trigger('focus');
        });

        $nodeInputTopic.autoComplete({
            delay: 0,
            minLength: 0,
            search: function () {
                return [
                    '*',
                    '${domain}/status/${device}/${channelIndex}/${datapoint}',
                    '${domain}/status/${program}',
                    '${domain}/status/${sysvar}',
                ].map((value) => {
                    return { value, label: value };
                });
            },
        });

        $('.node-typed-input-property-value').each(function () {
            $(this).typedInput({
                types: [
                    {
                        value: 'str',
                        label: 'string',
                        icon: 'red/images/typedInput/az.svg',
                        autoComplete: (value) => autoCompleteSearch(node, data, $(this).attr('id').slice(11), value),
                    },
                    { value: 're', label: 'regular expression', icon: 'red/images/typedInput/re.svg' },
                ],
                typeField: '#' + $(this).attr('id') + 'T',
            });
        });
    }

    RED.nodes.registerType(moduleName, {
        category: paletteCategory,
        color: paletteColor,
        defaults: {
            name: { value: '' },
            jack: { value: 'localhost', type: 'jack-config', required: true },
            domain: { value: '*' },
            topic: { value: '*' },
            interfaceType: { value: '' },
            interfaceTypeT: { value: 'str' },
            room: { value: '' },
            roomT: { value: 'str' },
            function: { value: '' },
            functionT: { value: 'str' },
            device: { value: '' },
            deviceT: { value: 'str' },
            deviceType: { value: '' },
            deviceTypeT: { value: 'str' },
            channel: { value: '' },
            channelT: { value: 'str' },
            channelType: { value: '' },
            channelTypeT: { value: 'str' },
            channelIndex: { value: '' },
            channelIndexT: { value: 'str' },
            datapoint: { value: '' },
            datapointT: { value: 'str' },
            program: { value: '' },
            programT: { value: 'str' },
            sysvar: { value: '' },
            sysvarT: { value: 'str' },
            change: { value: false },
            cache: { value: false },
        },
        align: 'left',
        icon: 'bridge.svg',
        inputs: 0,
        outputs: 1,
        label: function () {
            return this.name || this._('@ptweety/node-red-contrib-ccu-jack/messages:event.label.name');
        },
        paletteLabel: function () {
            return this._('@ptweety/node-red-contrib-ccu-jack/messages:event.label.name');
        },
        outputLabels: function (_) {
            return this._('@ptweety/node-red-contrib-ccu-jack/messages:event.node.output');
        },
        oneditprepare: function () {
            onEditPrepare(this);
        },
        oneditsave: function () {
            const $nodeInputDomain = $('#node-input-domain');
            const domain = $nodeInputDomain.val() || '';

            $('.node-typed-input-property-value').each(function () {
                if (!$(this).parent().hasClass(`for-${domain}`)) {
                    $(this).typedInput('type', 'str');
                    $(this).typedInput('value', '');
                }
            });
        },
    });
})();
</script>